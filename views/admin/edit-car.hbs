<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.min.js"></script>
<link rel="stylesheet"
    href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.css" type="text/css">


<div class="container-scroller">

    <!-- partial -->
    <div class="container-fluid page-body-wrapper">
        <!-- partial -->

        <!--sidebar.html -->
        {{>admin-sidebar}}
        <div class="main-panel">
            <div class="content-wrapper">
                <div class="row d-flex justify-content-center">
                    <div class="col-12 grid-margin">
                        <div class="card">
                            <div class="card-body">
                                <div class="text-center">

                                    <h3 class="card-title mb-5">Edit Car</h3>
                                </div>

                                <form onsubmit="return validateForm()" class="form-sample" action="/cars-management/edit-car/{{carData._id}}"
                                    method="post">
                                    {{!-- select brand model type--}}
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="form-group row">
                                                <div class="col-sm-9">
                                                    <p>Brand</p>
                                                    <input id="make" class="js-example-basic-single w-100 form-control"
                                                        name="brand" value="{{carData.brand}}" readonly />

                                                    <p class="text-danger" id="makemsg"></p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group row">
                                                <div class="col-sm-9">
                                                    <P>Model</P>
                                                    <input id="model" class="js-example-basic-single w-100 form-control"
                                                        name="model" value="{{carData.model}}" readonly />
                                                    <p class="text-danger" id="modelmsg"></p>

                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group row">
                                                <div class="col-sm-9">
                                                    <p>Type</p>
                                                    <input id="type" class="js-example-basic-single w-100 form-control"
                                                        name="type" value="{{carData.type}}" readonly />


                                                    <p class="text-danger" id="typemsg"></p>

                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                    {{!-- select brand model type--}}


                                    {{!-- regno drive no of seats fuel --}}
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="form-group row">
                                                <div class="col-sm-12">
                                                    <P>Registration no</P>
                                                    <input type="text" class="form-control" id="regno"
                                                        name="registrationNo" value="{{carData.registrationNo}}"
                                                        readonly />
                                                </div>
                                                <p class="text-danger" id="regnomsg"></p>

                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group row">
                                                <div class="col-sm-12">
                                                    <P>2WD / 4WD</P>
                                                    <input class="form-control" name="twowd_or_fourwd"
                                                        value="{{carData.twowd_or_fourwd}}" readonly />

                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group row">
                                                <div class="col-sm-12">
                                                    <p>No of seats</p>

                                                    <input class="form-control" name="no_of_seats"
                                                        value="{{carData.no_of_seats}}" readonly />

                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group row">
                                                <div class="col-sm-12">
                                                    <p>Fuel</p>
                                                    <input class="form-control" name="fuel" value="{{carData.fuel}}"
                                                        readonly />

                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                    {{!-- regno drive no of seats fuel --}}

                                    {{!-- year no of doors color --}}
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="form-group row">
                                                <div class="col-sm-12">
                                                    <P>Make year</P>
                                                    <input class="form-control" id="year" name="makeyear"
                                                        value="{{carData.makeyear}}" readonly />

                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group row">
                                                <div class="col-sm-12">
                                                    <P>No of doors</P>
                                                    <input class="form-control" name="no_of_doors"
                                                        value="{{carData.no_of_doors}}" readonly />

                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group row">
                                                <div class="col-sm-12">
                                                    <p>Color</p>
                                                    <input type="text" id="color" class="form-control" name="color"
                                                        value="{{carData.color}}" readonly />
                                                </div>
                                                <p class="text-danger" id="colormsg"></p>

                                            </div>
                                        </div>


                                    </div>
                                    {{!-- year no of doors color --}}

                                    {{!-- city pick_up_address price_per_day fine_per_day --}}
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="form-group row">
                                                <div class="col-sm-12">
                                                    <P>City</P>
                                                    <select id="city" class="form-control" name="city">
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-5">
                                            <div class="form-group row">
                                                <div class="col-sm-12">
                                                    <P>Pick up and drop address</P>
                                                    <input type="text" class="form-control" id="search_input"
                                                        onclick="return map()" name="pick_up_address"
                                                        value="{{carData.pick_up_address.address}}" readonly />
                                                    <input type="text" id="latitude" name="latitude"
                                                        value="{{carData.pick_up_address.latitude}}" hidden>
                                                    <input type="text" id="longitude" name="longitude"
                                                        value="{{carData.pick_up_address.longitude}}" hidden>
                                                </div>
                                                <p class="text-danger" id="addressmsg"></p>

                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="input-group row">
                                                <div class="col-sm-12">
                                                    <p>Rent per day</p>
                                                    <div class="d-flex">

                                                        <div class="input-group-prepend">
                                                            <span class="input-group-text">â‚¹</span>
                                                        </div>
                                                        <input type="text" class="form-control" name="price_per_day"
                                                            id="price" value="{{carData.price_per_day}}" />

                                                    </div>
                                                </div>
                                                <p class="text-danger" id="pricemsg"></p>
                                            </div>

                                        </div>
                                        {{!-- fine per day --}}
                                        {{!-- <div class="col-md-2">
                                            <div class="form-group row">
                                                <div class="col-sm-12">
                                                    <p>Fine per day</p>
                                                    <select class="form-control" name="fine_per_day">
                                                        <option>200%</option>
                                                        <option>150%</option>
                                                        <option>100%</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div> --}}


                                    </div>

                                    {{!-- city pick_up_address price_per_day fine_per_day --}}

                                    {{!-- features --}}
                                    <p>Features</p>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <div class="form-check">
                                                    <label class="form-check-label">
                                                        <input type="checkbox" class="form-check-input" name="features"
                                                            value="Apple Car Play">
                                                        Apple Car Play
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <label class="form-check-label">
                                                        <input type="checkbox" class="form-check-input" name="features"
                                                            value="Sunroof">
                                                        Sunroof
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <label class="form-check-label">
                                                        <input type="checkbox" class="form-check-input" name="features"
                                                            value="Auto Climate Control">
                                                        Auto Climate Control
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <label class="form-check-label">
                                                        <input type="checkbox" class="form-check-input" name="features"
                                                            value="Ventilated Seats">
                                                        Ventilated Seats
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <label class="form-check-label">
                                                        <input type="checkbox" class="form-check-input" name="features"
                                                            value="Auto Headlights">
                                                        Auto Headlights
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <label class="form-check-label">
                                                        <input type="checkbox" class="form-check-input" name="features"
                                                            value="Rain sensing vipers">
                                                        Rain sensing vipers
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <label class="form-check-label">
                                                        <input type="checkbox" class="form-check-input" name="features"
                                                            value="Massage seats">
                                                        Massaging seats
                                                    </label>
                                                </div>

                                            </div>
                                        </div>
                                        <div class="col-md-3">


                                            <div class="form-group">
                                                <div class="form-check">
                                                    <label class="form-check-label">
                                                        <input type="checkbox" class="form-check-input" name="features"
                                                            value="Parking sensors">
                                                        Parking sensors
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <label class="form-check-label">
                                                        <input type="checkbox" class="form-check-input" name="features"
                                                            value="Bluetooth">
                                                        Bluetooth
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <label class="form-check-label">
                                                        <input type="checkbox" class="form-check-input" name="features"
                                                            value="Usb charger">
                                                        Usb Charger
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <label class="form-check-label">
                                                        <input type="checkbox" class="form-check-input" name="features"
                                                            value="GPS">
                                                        Gps
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <label class="form-check-label">
                                                        <input type="checkbox" class="form-check-input" name="features"
                                                            value="Aux input">
                                                        Aux Input
                                                    </label>
                                                </div>

                                                <div class="form-check">
                                                    <label class="form-check-label">
                                                        <input type="checkbox" class="form-check-input" name="features"
                                                            value="Toll Pass">
                                                        Toll Pass
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <label class="form-check-label">
                                                        <input type="checkbox" class="form-check-input" name="features"
                                                            value="Mustbe 18 to book">
                                                        Mustbe 18 to book
                                                    </label>
                                                </div>

                                            </div>
                                        </div>
                                        {{!-- features --}}


                                        <div class="col-md-6">
                                            {{!-- discription images --}}
                                            <div class="row">
                                                <div class="col-md-12">
                                                    <div class="form-group row">
                                                        <div class="col-12 col-sm-12">
                                                            <p>Discription</p>
                                                            <textarea class="form-control" rows="3" name="discription"
                                                                id="discription"
                                                                style="height: 90px;">{{carData.discription}}</textarea>


                                                        </div>

                                                    </div>
                                                </div>

                                                <div class="form-group col-6">
                                                    <label>Change Main Image</label>
                                                    <div class="input-group col-xs-12">
                                                        <input class="form-control form-control-sm" type="file" onchange="" id="upload_image1">
                                                    </div>
                                                    <p class="text-danger" id="singlemsg1"></p>

                                                    <div id="single1"><img src="/images/car-images/{{carData.images.[0]}}"></div>
                                                </div>
                                                <input type="text" name="image" id="image1" value="{{carData.images.[0]}}" hidden>

                                                <div class="form-group col-6">
                                                    <label>Change Image</label>
                                                    <div class="input-group col-xs-12">
                                                        <input class="form-control form-control-sm" type="file" onchange="" id="upload_image2">
                                                    </div>
                                                    <p class="text-danger" id="singlemsg2"></p>

                                                    <div id="single2"><img src="/images/car-images/{{carData.images.[1]}}"></div>
                                                </div>
                                                <input type="text" name="image" id="image2" value="{{carData.images.[1]}}" hidden>


                                                <div class="form-group col-6">
                                                    <label>Change Image</label>
                                                    <div class="input-group col-xs-12">
                                                        <input class="form-control form-control-sm" type="file" onchange="" id="upload_image3">
                                                    </div>
                                                    <p class="text-danger" id="singlemsg3"></p>

                                                    <div id="single3"><img src="/images/car-images/{{carData.images.[2]}}"></div>
                                                </div>
                                                <input type="text" name="image" id="image3" value="{{carData.images.[2]}}" hidden>


                                                <div class="form-group col-6">
                                                    <label>Change Image</label>
                                                    <div class="input-group col-xs-12">
                                                        <input class="form-control form-control-sm" type="file" onchange="" id="upload_image4">
                                                    </div>
                                                    <p class="text-danger" id="singlemsg4"></p>

                                                    <div id="single4"><img src="/images/car-images/{{carData.images.[3]}}"></div>
                                                </div>
                                                <input type="text" name="image" id="image4" value="{{carData.images.[3]}}" hidden>





                                            </div>
                                            {{!-- discription images --}}

                                        </div>
                                        <div class="d-flex justify-content-center">
                                            <button type="submit" class="btn btn-primary me-2">Submit</button>

                                        </div>
                                </form>



                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <!-- page-body-wrapper ends -->
</div>

<div class="" align="">
    <div class="modal" id="modal-map" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog modal-md" role="document">
            <div class="modal-content">
                <div class="modal-header p-2">
                    <h6 id="address" class="modal-title">Place Pointer in your location</h6>

                    <button type="button" onclick="return closemodel()" class="close" data-dismiss="modal"
                        aria-label="Close">
                        <span aria-hidden="true">x</span>
                    </button>
                </div>
                <div class="modal-body p-0">

                    <div id="map" style="height: 400px;"></div>

                </div>
                <div class="modal-footer p-2">
                    <button type="button" onclick="return closemodel()" class="btn btn-sm btn-primary"
                        data-dismiss="modal">OK</button>

                </div>
            </div>
        </div>
    </div>
</div>
<div class="container" align="center">
    <div class="modal fade" id="modal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog modal-md" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Crop Image Before Upload</h5>
                    <button type="button" onclick="return closemodel()" class="close" data-dismiss="modal"
                        aria-label="Close">
                        <span aria-hidden="true">x</span>
                    </button>
                </div>
                <div class="modal-body p-0">

                    <div class="row d-flex justify-content-center">
                        <div class="col-md-11 p-0">
                            <img src="" id="sample_image" class="imgcropping" />
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" id="crop" class="btn btn-primary">Crop</button>
                    <button type="button" onclick="return closemodel()" class="btn btn-secondary"
                        data-dismiss="modal">Cancel</button>

                </div>
            </div>
        </div>
    </div>
</div>


<script>
    const address = document.getElementById('address');
    const coordinates = document.getElementById('coordinates');
    const addressInput = document.getElementById('search_input')
    const latitude = document.getElementById('latitude')
    const longitude = document.getElementById('longitude')

    mapboxgl.accessToken = 'pk.eyJ1Ijoiam9lc2hhamFuIiwiYSI6ImNreTJsYXA1cTBibTAybmw1ZXZuYW13enIifQ.C263rdaHgVlMR9AIgxYqYw';


    function getAddress(lng, lat) {

        longitude.value = lng
        latitude.value = lat

        fetch("https://api.mapbox.com/geocoding/v5/mapbox.places/" + lng + "," + lat + ".json?types=poi&access_token=" + mapboxgl.accessToken)

            .then((response) => response.json())
            .then((data) => {
                if (data.features[0].place_name) {

                    address.innerHTML = data.features[0].place_name
                    addressInput.value = data.features[0].place_name
                }
            })
        return
    }

    function map() {
        var $modalmap = $('#modal-map');
        $modalmap.modal('show');

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition);
        }



        function showPosition(position) {
            lat = position.coords.latitude
            long = position.coords.longitude
            getAddress(long, lat)
            const map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v11',
                center: [long, lat],
                zoom: 15
            });
            const marker1 = new mapboxgl.Marker({
                draggable: true,

            })
                .setLngLat([long, lat])
                .addTo(map);

            marker1.on('dragend', e => {
                let LngLat = e.target.getLngLat()

                getAddress(LngLat.lng, LngLat.lat)

            })

            const geocoder = new MapboxGeocoder({
                mapboxgl: mapboxgl,
                accessToken: mapboxgl.accessToken,
                marker: false,

            })



            geocoder.on('result', e => {
                let lng = e.result.geometry.coordinates[1]
                let lat = e.result.geometry.coordinates[0]

                marker1.setLngLat(e.result.center)
                    .addTo(map)

                longitude.value = lng
                latitude.value = lat

                address.innerHTML = e.result.place_name
                addressInput.value = e.result.place_name

            })
            map.addControl(geocoder)
        }

    }



    //get city into input field
    async function getCityNames() {

        url = '/location-management/get-all-cities/'
        let response = await fetch(url)
        const data = await response.json()
        return data
    }

    getCityNames().then((data) => {
        data.sort()
        for (x of data) {
            document.getElementById("city").innerHTML += '<option>' + x + '</option>'

        }

    })

    //===========form validation===================

    function validateForm() {
        let brand = document.getElementById("make").value
        let model = document.getElementById("model").value
        let type = document.getElementById("type").value
        let regno = document.getElementById("regno").value
        let color = document.getElementById("color").value
        let search_input = document.getElementById("search_input").value
        let price = document.getElementById("price").value
        let discription = document.getElementById("discription").value
        let upload_image1 = document.getElementById("upload_image1")
        let upload_image2 = document.getElementById("upload_image2")
        let upload_image3 = document.getElementById("upload_image3")
        let upload_image4 = document.getElementById("upload_image4")




        if (brand == "") {
            document.getElementById("makemsg").innerHTML = "Please select any brand"
            return false
        } else {
            document.getElementById("makemsg").innerHTML = ""

        }

        if (model == "" || model === "Select model...") {
            document.getElementById("modelmsg").innerHTML = "Please select any model"
            return false
        } else {
            document.getElementById("modelmsg").innerHTML = ""

        }

        if (type == "" || type === "Select type...") {
            document.getElementById("typemsg").innerHTML = "Please select any type"
            return false
        } else {
            document.getElementById("typemsg").innerHTML = ""

        }

        if (regno == "") {
            document.getElementById("regnomsg").innerHTML = "Please enter car's regestration no"
            return false
        } else {
            document.getElementById("regnomsg").innerHTML = ""

        }
        if (color == "") {
            document.getElementById("colormsg").innerHTML = "Please fill the car's color"
            return false
        } else {
            document.getElementById("colormsg").innerHTML = ""

        }
        if (search_input == "") {
            document.getElementById("addressmsg").innerHTML = "Please fill the car's pickup and drop address"
            return false
        } else {
            document.getElementById("addressmsg").innerHTML = ""

        }
        if (price == "") {
            document.getElementById("pricemsg").innerHTML = "Please fill the rent per day"
            return false
        } else {
            document.getElementById("pricemsg").innerHTML = ""

        }

    }



    function closemodel() {
        console.log('in close');
        var $modal = $('#modal');
        $modal.modal('hide');
        var $modalmap = $('#modal-map');
        $modalmap.modal('hide');
    }


    $(document).ready(function () {
        let allowedExtensions = /(\.jpg|\.jpeg|\.png)$/i;

        var $modal = $('#modal');

        var image = document.getElementById('sample_image');

        var cropper;
        var img = 0
        $('#upload_image1').change(function (event) {
            img = 1
            var files = event.target.files;

            if (!allowedExtensions.exec(files[0].name)) {
                document.getElementById("singlemsg1").innerHTML = "Please upload only images."
                return false;
            } else {
                document.getElementById("singlemsg1").innerHTML = ""

            }

            var done = function (url) {
                image.src = url;
                $modal.modal('show');

            };

            if (files && files.length > 0) {
                reader = new FileReader();
                reader.onload = function (event) {
                    done(reader.result);
                };
                reader.readAsDataURL(files[0]);
            }
        });

        $('#upload_image2').change(function (event) {
            img = 2
            var files = event.target.files;
            if (!allowedExtensions.exec(files[0].name)) {
                document.getElementById("singlemsg2").innerHTML = "Please upload only images."
                return false;
            } else {
                document.getElementById("singlemsg2").innerHTML = ""

            }
            var done = function (url) {
                image.src = url;
                $modal.modal('show');
            };

            if (files && files.length > 0) {
                reader = new FileReader();
                reader.onload = function (event) {
                    done(reader.result);
                };
                reader.readAsDataURL(files[0]);
            }

        });
        $('#upload_image3').change(function (event) {
            img = 3
            var files = event.target.files;
            if (!allowedExtensions.exec(files[0].name)) {
                document.getElementById("singlemsg3").innerHTML = "Please upload only images."
                return false;
            } else {
                document.getElementById("singlemsg3").innerHTML = ""

            }
            var done = function (url) {
                image.src = url;
                $modal.modal('show');
            };

            if (files && files.length > 0) {
                reader = new FileReader();
                reader.onload = function (event) {
                    done(reader.result);
                };
                reader.readAsDataURL(files[0]);
            }

        });
        $('#upload_image4').change(function (event) {
            img = 4
            var files = event.target.files;
            if (!allowedExtensions.exec(files[0].name)) {
                document.getElementById("singlemsg4").innerHTML = "Please upload only images."
                return false;
            } else {
                document.getElementById("singlemsg4").innerHTML = ""

            }
            var done = function (url) {
                image.src = url;
                $modal.modal('show');
            };

            if (files && files.length > 0) {
                reader = new FileReader();
                reader.onload = function (event) {
                    done(reader.result);
                };
                reader.readAsDataURL(files[0]);
            }

        });

        $modal.on('shown.bs.modal', function () {
            cropper = new Cropper(image, {
                aspectRatio: 2,
                viewMode: 3,
                preview: '.preview'
            });
        }).on('hidden.bs.modal', function () {
            cropper.destroy();
            cropper = null;
        });


        $('#crop').click(function () {
            canvas = cropper.getCroppedCanvas({
                width: 1900,
                height: 1200
            });

            canvas.toBlob(function (blob) {
                url = URL.createObjectURL(blob);
                var reader = new FileReader();
                reader.readAsDataURL(blob);
                reader.onloadend = function () {
                    var base64data = reader.result;
                    if (img == 1) {

                        document.getElementById("image1").value = base64data;
                        $modal.modal('hide');
                        document.getElementById("single1").innerHTML = '<img src="' + base64data + '">';
                    }
                    if (img == 2) {

                        document.getElementById("image2").value = base64data;
                        $modal.modal('hide');
                        document.getElementById("single2").innerHTML = '<img src="' + base64data + '">';
                    }
                    if (img == 3) {

                        document.getElementById("image3").value = base64data;
                        $modal.modal('hide');
                        document.getElementById("single3").innerHTML = '<img src="' + base64data + '">';
                    }
                    if (img == 4) {

                        document.getElementById("image4").value = base64data;
                        $modal.modal('hide');
                        document.getElementById("single4").innerHTML = '<img src="' + base64data + '">';
                    }

                };
            });
        });





    });













</script>